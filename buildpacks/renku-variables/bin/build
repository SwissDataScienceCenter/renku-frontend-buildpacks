#!/usr/bin/env bash
set -eo pipefail

echo -e "=== ðŸ”§ \033[1mRenku Environment Variables buildpack\033[0m ==="

# NOTE: we run platform mismatch check here as this buildpack is always selected
CURRENT_ARCH="$(uname -m)"
case "${CURRENT_ARCH}" in
  "aarch64"|"arm64") CURRENT_ARCH="arm64" ;;
  "amd64"|"x86_64") CURRENT_ARCH="amd64" ;;
  *) >&2 echo "ERROR: Unsupported architecture: ${CURRENT_ARCH}" ;;
esac

if [ -n "${CNB_TARGET_ARCH:-}" ]; then
  if [ "${CNB_TARGET_ARCH}" != "${CURRENT_ARCH}" ]; then
    >&2 echo "ERROR: current architecture ${CURRENT_ARCH} does not match target architecture ${CNB_TARGET_ARCH}!"
    exit 1
  fi
fi


layers_dir="$1"
layer_dir="${layers_dir}"/renku-env
env_dir="${layer_dir}"/env.launch
mkdir -p "${env_dir}"

printf "/bin/bash" >"${env_dir}/SHELL.default"
echo "Added default value for \$SHELL"

printf "0.0.0.0" >"${env_dir}/RENKU_SESSION_IP.default"
echo "Added default value for \$RENKU_SESSION_IP"

printf "8000" >"${env_dir}/RENKU_SESSION_PORT.default"
echo "Added default value for \$RENKU_SESSION_PORT"

printf "/workspace" >"${env_dir}/RENKU_MOUNT_DIR.default"
echo "Added default value for \$RENKU_MOUNT_DIR"

printf "/workspace" >"${env_dir}/RENKU_WORKING_DIR.default"
echo "Added default value for \$RENKU_WORKING_DIR"

printf "/" >"${env_dir}/RENKU_BASE_URL_PATH.default"
echo "Added default value for \$RENKU_BASE_URL_PATH"

cat >"${layer_dir}.toml" <<EOL
[types]
launch = true
EOL
