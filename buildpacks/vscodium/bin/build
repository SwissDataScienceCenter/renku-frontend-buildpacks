#!/usr/bin/env bash
set -eou pipefail

echo -e "=== âœ¨ \033[1mRenku VSCodium buildpack\033[0m ==="

echo "  Build configuration:"
echo -e "    \$BP_RENKU_FRONTENDS\t${BP_RENKU_FRONTENDS}\tThe frontends to install"

layers_dir="${CNB_LAYERS_DIR}"
buildpack_dir="${CNB_BUILDPACK_DIR}"
vscodium_layer_dir="${layers_dir}"/vscodium
preinstalled_extensions_dir="${vscodium_layer_dir}"/preinstalled_extensions
cache_layer_dir="${layers_dir}"/cache
execd_layer_dir="${vscodium_layer_dir}"/exec.d
launch_env_dir="${vscodium_layer_dir}"/env.launch
vscodium_bin_dir="${vscodium_layer_dir}"/bin
vscodium_extensions_file=".vscode/extensions.json"
mkdir -p "${vscodium_layer_dir}"
mkdir -p "${preinstalled_extensions_dir}"
mkdir -p "${launch_env_dir}"
mkdir -p "${execd_layer_dir}"
mkdir -p "${cache_layer_dir}"

unset LD_LIBRARY_PATH

ARCH="${CNB_TARGET_ARCH:-unknown}"
case "${ARCH}" in
  "amd64") ARCH="x64" ;;
esac

VSCODIUM_DEFAULT_VERSION="1.104.36664"
BP_VSCODIUM_VERSION="${BP_VSCODIUM_VERSION:-${VSCODIUM_DEFAULT_VERSION}}"
VSCODIUM_ARCHIVE="vscodium-reh-web-linux-${ARCH}-${BP_VSCODIUM_VERSION}.tar.gz"
VSCODIUM_URL="https://github.com/VSCodium/vscodium/releases/download/${BP_VSCODIUM_VERSION}/${VSCODIUM_ARCHIVE}"
DEFAULT_VSCODIUM_EXTENSIONS="ms-python.python ms-toolsai.jupyter"

echo "Installing VSCodium version: ${BP_VSCODIUM_VERSION} on ${ARCH}"

curl -sSLo "${cache_layer_dir}/${VSCODIUM_ARCHIVE}" -C - "${VSCODIUM_URL}"
tar -xzf "${cache_layer_dir}/${VSCODIUM_ARCHIVE}" -C "${vscodium_layer_dir}"
cp "${buildpack_dir}/bin/vscodium-entrypoint.sh" "${vscodium_bin_dir}/vscodium-entrypoint.sh"
chmod 755 "${vscodium_bin_dir}"/vscodium-entrypoint.sh

VSCODIUM_EXTENSIONS="${DEFAULT_VSCODIUM_EXTENSIONS}"
if [ -f "${vscodium_extensions_file}" ]; then
  set +eo pipefail
  NODE_JS_VERSION="24.11.1"
  NODE_JS_ARCHIVE="node-v${NODE_JS_VERSION}-linux-${ARCH}.tar.xz"
  NODE_JS_URL="https://nodejs.org/dist/v${NODE_JS_VERSION}/node-v${NODE_JS_VERSION}-linux-${ARCH}.tar.xz"
  mkdir -p "${cache_layer_dir}/node"
  curl -sSLo "${cache_layer_dir}/node/${NODE_JS_ARCHIVE}" -C - "${NODE_JS_URL}"
  tar -xJf  "${cache_layer_dir}/node/${NODE_JS_ARCHIVE}" -C "${cache_layer_dir}/node"
  NODE_JS_DIR="${cache_layer_dir}/node/node-v${NODE_JS_VERSION}-linux-${ARCH}"
  NODE_JS_BIN_DIR="${NODE_JS_DIR}/bin"
  cp -R "${buildpack_dir}/bin/extensions-parser" "${cache_layer_dir}/node/"
  "${NODE_JS_BIN_DIR}/node" "${NODE_JS_BIN_DIR}/npm" clean-install --prefix "${cache_layer_dir}/node/extensions-parser"
  VSCODIUM_EXTENSIONS=$("${NODE_JS_BIN_DIR}/node" "${cache_layer_dir}/node/extensions-parser/jsonc_to_json.js" "${vscodium_extensions_file}" \
    | jq -r 'try .recommendations[]' | tr '\n' ' ')
  if [ -z "${VSCODIUM_EXTENSIONS}" ]; then
    >&2 echo "ERROR: Failed to parse extensions to install with VSCodium!"
    VSCODIUM_EXTENSIONS="${DEFAULT_VSCODIUM_EXTENSIONS}"
  fi
  set -eo pipefail
fi

echo "Installing extensions:"
echo "> ${VSCODIUM_EXTENSIONS}"
for extension in ${VSCODIUM_EXTENSIONS}; do
  echo "Installing VSCode extension: ${extension}"
  "${vscodium_bin_dir}/codium-server" \
    --extensions-dir "${preinstalled_extensions_dir}" \
    --install-extension "${extension}" || \
    echo "Couldn't install extension ${extension}"
done

mkdir -p "${launch_env_dir}"
printf '%s' "${VSCODIUM_EXTENSIONS}" >"${launch_env_dir}/VSCODIUM_EXTENSIONS.default"

cat >"${execd_layer_dir}"/install-extensions.sh <<EOL
#!/usr/bin/env bash
set -eo pipefail
VSCODIUM_DATA_DIR="\${RENKU_MOUNT_DIR}/.vscode"
mkdir -p "\${VSCODIUM_DATA_DIR}/extensions" || VSCODIUM_DATA_DIR="\${RENKU_MOUNT_DIR}/.vscode_"
mkdir -p "\${VSCODIUM_DATA_DIR}/extensions"
image_extensions="\$(ls -A ${preinstalled_extensions_dir})"
for extension in \${image_extensions[@]}; do
  if [ -f "${preinstalled_extensions_dir}/\${extension}/package.json" ]; then
    cp -R "${preinstalled_extensions_dir}/\${extension}" "\${VSCODIUM_DATA_DIR}/extensions/"
  fi
done
for extension in \${VSCODIUM_EXTENSIONS[@]}; do
    echo "Installing VSCode extension: \${extension}"
    codium-server \
    --extensions-dir "\${VSCODIUM_DATA_DIR}/extensions" \
    --server-data-dir "\${VSCODIUM_DATA_DIR}" \
    --install-extension \${extension} || \
    echo "Couldn't install extension \${extension}"
done
EOL
chmod 755 "${execd_layer_dir}"/install-extensions.sh

# Write layer metadata (CNB requirement)
cat >"${layers_dir}/vscodium.toml" <<EOL
[types]
launch = true

[metadata]
description = "vscodium frontend for renku"
version = "0.0.6"
EOL

cat >"${layers_dir}/cache.toml" <<EOL
[types]
cache = true
EOL

# 4. SET DEFAULT START COMMAND
cat >"${layers_dir}/launch.toml" <<EOL
[[processes]]
type = "vscodium"
command = ["tini", "-g", "--"]
args = ["bash", "${vscodium_bin_dir}/vscodium-entrypoint.sh"]
default = true
EOL
