#!/usr/bin/env bash
set -eo pipefail

echo -e "=== âœ¨ \033[1mRenku Jupyterlab buildpack\033[0m ==="

echo "  Build configuration:"
echo -e "    \$BP_RENKU_FRONTENDS\t${BP_RENKU_FRONTENDS}\tThe frontends to install"

layers_dir="${CNB_LAYERS_DIR}"
buildpack_dir="${CNB_BUILDPACK_DIR}"
cache_layer_dir="${layers_dir}"/cache
jupyter_layer_dir="${layers_dir}"/jupyterlab
jupyter_environment_dir="${jupyter_layer_dir}"/jupyterlab_env
jupyterlab_extensions_requirements_file="jupyterlab_extensions.txt"
mkdir -p "${jupyter_layer_dir}"/bin
mkdir -p "${cache_layer_dir}"

unset PYTHONPATH
conda config --remove channels defaults
conda config --add pkgs_dirs "${cache_layer_dir}"
conda env create -y -p "${jupyter_environment_dir}" -f "${buildpack_dir}/bin/jupyter-environment.yml"
# shellcheck source=/dev/null
. "$(dirname "$(dirname "$(which conda)")")"/etc/profile.d/conda.sh
conda activate "${jupyter_environment_dir}"
jupyter kernelspec remove -f python3
jupyter labextension disable "@jupyterlab/apputils-extension:announcements"
# Install jupyterlab extensions required by the project
if [ -f "${jupyterlab_extensions_requirements_file}" ]; then
  echo "Installing Jupyterlab extensions from ${jupyterlab_extensions_requirements_file}"
  jupyterlab_version="$(python -c 'import jupyterlab; print(jupyterlab.__version__)')"
  constraint_file="${jupyter_layer_dir}/contraint.txt"
  echo "jupyterlab==${jupyterlab_version}" > "${constraint_file}"
  pip install -r "${jupyterlab_extensions_requirements_file}" --no-input --quiet --progress-bar off --constraint "${constraint_file}" \
    || echo "Failed to install extensions!"
  rm "${constraint_file}"
fi
conda deactivate

cp "${buildpack_dir}/bin/jupyterlab-entrypoint.sh" "${jupyter_layer_dir}/bin/jupyterlab-entrypoint.sh"
chmod ug+x "${jupyter_layer_dir}"/bin/jupyterlab-entrypoint.sh

# Write layer metadata (CNB requirement)
cat >"${layers_dir}/jupyterlab.toml" <<EOL
[types]
launch = true

[metadata]
description = "jupyterlab frontend for renku"
version = "0.0.6"
EOL

# 4. SET DEFAULT START COMMAND
cat >"${layers_dir}/launch.toml" <<EOL
[[processes]]
type = "jupyterlab"
command = ["tini", "-g", "--"]
args = ["bash", "${jupyter_layer_dir}/bin/jupyterlab-entrypoint.sh", "${jupyter_environment_dir}"]
default = true
EOL
