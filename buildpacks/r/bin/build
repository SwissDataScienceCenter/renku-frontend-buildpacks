#!/usr/bin/env bash
set -eou pipefail

echo -e "=== âœ¨ \033[1mRenku R buildpack\033[0m ==="

r_layer_dir="${CNB_LAYERS_DIR}/r"
env_dir="${r_layer_dir}/env"
cache_layer_dir="${CNB_LAYERS_DIR}/cache"
source_dir="${cache_layer_dir}/source"
mkdir -p "${r_layer_dir}/bin"
mkdir -p "${env_dir}"
mkdir -p "${source_dir}"

R_VERSION="$(jq -r ".R.Version" "renv.lock")"

pushd "${source_dir}"
curl -O "https://cran.rstudio.com/src/base/R-4/R-${R_VERSION}.tar.gz"
tar -xzf "R-${R_VERSION}.tar.gz"
cd "R-${R_VERSION}"
./configure \
--prefix="${r_layer_dir}" \
--enable-R-shlib \
--enable-memory-profiling \
--with-blas \
--with-lapack && \
make && make install
popd

printf "pdf" >"${env_dir}/R_INTERACTIVE_DEVICE.default"
printf "%s/lib/R/library" "${r_layer_dir}" >"${env_dir}/R_LIBS_SITE.default"

export EDITOR=vim
echo "EDITOR=${EDITOR}" > "${r_layer_dir}/lib/R/etc/Renviron.site"

"${r_layer_dir}/bin/R" -e "utils::install.packages('renv', lib='${r_layer_dir}/lib/R/library', repos='http://cran.r-project.org')"

cat >"${r_layer_dir}".toml <<EOL
[types]
build = true
launch = true

[metadata]
description = "Install R and dependencies"
version = "0.0.5"
EOL

cat >"${cache_layer_dir}".toml <<EOL
[types]
cache = true
EOL
