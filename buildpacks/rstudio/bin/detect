#!/usr/bin/env bash
set -eo pipefail

if [[ "${BP_RENKU_FRONTENDS}" =~ "rstudio" ]]; then
  echo "PASS: The BP_RENKU_FRONTENDS environment variable was found to contain rstudio."
else
  echo "SKIPPED:The BP_RENKU_FRONTENDS environment variable is not set or does not contain rstudio."
  exit 100
fi

if [ -f "renv.lock" ]; then
  # R is compiled from source
  cat >"${CNB_BUILD_PLAN_PATH}" <<EOL
[[provides]]
  name = "rstudio"

[[requires]]
  name = "renku-env"
[requires.metadata]
  launch = true

[[requires]]
  name = "jq-likes"
[requires.metadata]
  build = true
  launch = false

[[requires]]
  name = "r"
[requires.metadata]
  launch = true

[[requires]]
  name = "rstudio"
[requires.metadata]
  launch = true
EOL
elif [ -f "environment.yml" ]; then
  # R should be installed via conda
  R_INSTALLED_IN_CONDA=$(cat environment.yml | yq '.dependencies[] | select( . | test("^r-base"))')
  if [[ -z "$R_INSTALLED_IN_CONDA" ]]; then
    echo "Found an environment.yml file but could not find the 'r-base' package inside, please add it if you wish to use Rstudio."
    exit 100
  fi
  cat >"${CNB_BUILD_PLAN_PATH}" <<EOL
[[provides]]
  name = "rstudio"

[[requires]]
  name = "renku-env"
[requires.metadata]
  launch = true

[[requires]]
  name = "conda"
[requires.metadata]
  build = true

[[requires]]
  name = "conda-environment"
[requires.metadata]
  launch = true

[[requires]]
  name = "rstudio"
[requires.metadata]
  launch = true
EOL
else
  echo "Could not find any suitable way to install R and R is needed in order to use Rstudio"
  exit 100
fi
