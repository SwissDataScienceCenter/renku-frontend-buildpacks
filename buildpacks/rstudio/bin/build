#!/usr/bin/env bash
set -eo pipefail

echo -e "=== âœ¨ \033[1mRenku RStudio buildpack\033[0m ==="

echo "  Build configuration:"
echo -e "    \$BP_RENKU_FRONTENDS\t${BP_RENKU_FRONTENDS}\tThe frontends to install"

layers_dir="${CNB_LAYERS_DIR}"
buildpack_dir="${CNB_BUILDPACK_DIR}"
cache_layer_dir="${layers_dir}"/cache
rstudio_layer_dir="${layers_dir}"/rstudio
r_layer_dir="${layers_dir}"/r
mkdir -p "${rstudio_layer_dir}"/bin
mkdir -p "${cache_layer_dir}"

RSTUDIO_VERSION="2025.09.2-418"
OS_CODENAME=jammy # https://posit.co/download/rstudio-server gives jammy regardless of ubuntu version
FNAME="rstudio-$RSTUDIO_VERSION.deb"

ARCH="${CNB_TARGET_ARCH:-unknown}"

if [ -f "$cache_layer_dir/$FNAME" ]; then
	echo "Found rstudio $RSTUDIO_VERSION in $cache_layer_dir skipping download"
else
	echo "Downloading rstudio $RSTUDIO_VERSION in $cache_layer_dir"
  # Use the URLs from https://dailies.rstudio.com since they offer more os/arch combinations
  curl -sSL "https://s3.amazonaws.com/rstudio-ide-build/server/$OS_CODENAME/$ARCH/rstudio-server-$RSTUDIO_VERSION-$ARCH.deb" -o "$cache_layer_dir/$FNAME"
fi

echo "Unpacking $cache_layer_dir/$FNAME in /tmp/rstudio"
mkdir -p /tmp/rstudio
dpkg -x "$cache_layer_dir/$FNAME" "/tmp/rstudio"
cp -r /tmp/rstudio/usr/lib/rstudio-server/* "$rstudio_layer_dir/"

cp "${buildpack_dir}/bin/rstudio-entrypoint.sh" "${rstudio_layer_dir}"/bin/rstudio-entrypoint.sh

# Rstudio needs R to run, use conda to install it
# NOTE: That the latest R version may not be immediately available through conda

mkdir -p "$cache_layer_dir/pkgs_dir"
conda config --add pkgs_dirs "$cache_layer_dir/pkgs_dir"
conda config --remove channels defaults
conda create --prefix "${r_layer_dir}" -c conda-forge r-base="$R_VERSION"

# Write layer metadata (CNB requirement)
cat >"${layers_dir}/rstudio.toml" <<EOL
[types]
launch = true

[metadata]
description = "rstudio frontend for renku"
version = "0.0.6"
EOL

cat >"${layers_dir}/r.toml" <<EOL
[types]
launch = true

[metadata]
description = "r"
version = "0.0.6"
EOL

cat >"${layers_dir}/cache.toml" <<EOL
[types]
cache = true
EOL

# 4. SET DEFAULT START COMMAND
cat >"${layers_dir}/launch.toml" <<EOL
[[processes]]
type = "rstudio"
command = ["tini", "-g", "--"]
args = ["bash", "rstudio-entrypoint.sh"]
default = true
[[processes]]
type = "bash"
command = ["bash"]
default = false
EOL
