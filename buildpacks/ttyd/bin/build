#!/usr/bin/env bash
set -eo pipefail

echo "=== Renku TTYD buildpack ==="

layers_dir="${CNB_LAYERS_DIR}"
buildpack_dir="${CNB_BUILDPACK_DIR}"
ttyd_layer_dir="${layers_dir}"/ttyd
launch_env_dir="${ttyd_layer_dir}"/env.launch
ttyd_bin_dir="${ttyd_layer_dir}"/bin
mkdir -p "${ttyd_bin_dir}"
mkdir -p "${launch_env_dir}"

ARCH=$(uname -i)
TTYD_VERSION="1.7.7"
TTYD_URL="https://github.com/tsl0922/ttyd/releases/download/${TTYD_VERSION}/ttyd.${ARCH}"

cd "${ttyd_bin_dir}"
curl -Lo ttyd "${TTYD_URL}"
chmod 755 ttyd
cp "${buildpack_dir}/bin/ttyd-entrypoint.sh" "${ttyd_bin_dir}/ttyd-entrypoint.sh"
chmod 755 "${ttyd_bin_dir}"/ttyd-entrypoint.sh

mkdir -p "${launch_env_dir}"
printf "/bin/bash" >"${launch_env_dir}/SHELL.default"
printf "0.0.0.0" >"${launch_env_dir}/RENKU_SESSION_IP.default"
printf "8000" >"${launch_env_dir}/RENKU_SESSION_PORT.default"
printf "/workspace" >"${launch_env_dir}/RENKU_MOUNT_DIR.default"
printf "/workspace" >"${launch_env_dir}/RENKU_WORKING_DIR.default"
printf "/" >"${launch_env_dir}/RENKU_BASE_URL_PATH.default"


# Write layer metadata (CNB requirement)
cat >"${layers_dir}/ttyd.toml" <<EOL
[types]
launch = true

[metadata]
description = "ttyd frontend for renku"
version = "0.0.6"
EOL

# 4. SET DEFAULT START COMMAND
cat >"${layers_dir}/launch.toml" <<EOL
[[processes]]
type = "ttyd"
command = ["tini", "-g", "--"]
args = ["bash", "${ttyd_bin_dir}/ttyd-entrypoint.sh"]
default = true
EOL
