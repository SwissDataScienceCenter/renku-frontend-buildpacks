#!/usr/bin/env bash
set -eo pipefail

echo -e "=== âœ¨ \033[1mRenku TTYD buildpack\033[0m ==="

echo "  Build configuration:"
echo -e "    \$BP_RENKU_FRONTENDS\t${BP_RENKU_FRONTENDS}\tThe frontends to install"

layers_dir="${CNB_LAYERS_DIR}"
buildpack_dir="${CNB_BUILDPACK_DIR}"
ttyd_layer_dir="${layers_dir}"/ttyd
ttyd_bin_dir="${ttyd_layer_dir}"/bin
mkdir -p "${ttyd_bin_dir}"

ARCH=$(uname -i)
TTYD_VERSION="1.7.7"
TTYD_URL="https://github.com/tsl0922/ttyd/releases/download/${TTYD_VERSION}/ttyd.${ARCH}"

cd "${ttyd_bin_dir}"
curl -Lo ttyd "${TTYD_URL}"
chmod 755 ttyd
cp "${buildpack_dir}/bin/ttyd-entrypoint.sh" "${ttyd_bin_dir}/ttyd-entrypoint.sh"
chmod 755 "${ttyd_bin_dir}"/ttyd-entrypoint.sh

# Write layer metadata (CNB requirement)
cat >"${layers_dir}/ttyd.toml" <<EOL
[types]
launch = true

[metadata]
description = "ttyd frontend for renku"
version = "0.0.6"
EOL

# 4. SET DEFAULT START COMMAND
cat >"${layers_dir}/launch.toml" <<EOL
[[processes]]
type = "ttyd"
command = ["tini", "-g", "--"]
args = ["bash", "${ttyd_bin_dir}/ttyd-entrypoint.sh"]
default = true
EOL
