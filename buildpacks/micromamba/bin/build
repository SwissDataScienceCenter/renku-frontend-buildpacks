#!/usr/bin/env bash
set -eo pipefail

echo "=== Renku micromamba installer buildpack: BUILD ==="

# TODO: Handle installing a specific version of micromamba
# TODO: Once you can install a specific version of micromamba then handle caching

layers_dir=$1
mamba_layer_dir=${layers_dir}/micromamba
mkdir -p "${mamba_layer_dir}"
env_dir=${mamba_layer_dir}/env.build
mkdir -p "${env_dir}"

curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest -o "${mamba_layer_dir}/micromamba.bzip2"
tar -xvjf "${mamba_layer_dir}/micromamba.bzip2" -C "${mamba_layer_dir}"
rm "${mamba_layer_dir}/micromamba.bzip2"

printf ':' >"${env_dir}/PATH.delim"
printf '%s' "${mamba_layer_dir}/bin" >"${env_dir}/PATH.prepend"

cat >"${mamba_layer_dir}.toml" <<EOL
[types]
build = true
EOL
