#!/usr/bin/env bash
set -eo pipefail

output_dir=$CNB_OUTPUT_DIR

R_VERSION=$(jq -r ".R.Version" "renv.lock")

if [[ -z "$R_VERSION" ]]; then
  >&2 echo "Could not extract R version."
  exit 100
fi

echo "Extracted R version $R_VERSION"

# NOTE: Instructions for R installation are from https://docs.posit.co/resources/install-r-source.html

cat >>"${output_dir}/run.Dockerfile" <<EOL
ARG base_image
FROM \${base_image}
ARG user_id
USER root
RUN sed 's/^Types: deb$/Types: deb-src/g' /etc/apt/sources.list.d/ubuntu.sources > /etc/apt/sources.list.d/deb-src-ubuntu.sources && \
  apt-get update -y && \
  apt-get install -y curl \
  default-jdk || (rm -f /var/lib/dpkg/info/*jdk* && rm -f /var/lib/dpkg/info/*jre* && apt-get install -y default-jdk) && \
  apt-get build-dep -y --no-install-recommends r-base && \
  curl -O https://cran.rstudio.com/src/base/R-4/R-${R_VERSION}.tar.gz && \
  tar -xzvf R-${R_VERSION}.tar.gz && \
  cd R-${R_VERSION} && \
  ./configure \
  --enable-R-shlib \
  --enable-memory-profiling \
  --with-blas \
  --with-lapack && \
  make && \
  make install && \
  cd .. && \
  rm -rf /var/lib/apt/lists/* && \
  rm -rf R-${R_VERSION} && \
  rm -rf R-${R_VERSION}.tar.gz
USER \$user_id
EOL
